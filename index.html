<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HelpingMyMama - 榮譽榜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-active:active { background-color: #fef3c7; transform: scale(0.96); transition: 0.1s; }
        .btn-plus:active { background-color: #15803d; transform: scale(0.9); }
        .btn-minus:active { background-color: #b91c1c; transform: scale(0.9); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-10">

    <nav class="bg-orange-500 text-white p-5 shadow-lg sticky top-0 z-50">
        <h1 class="text-2xl font-bold text-center">四桂 班級榮譽榜</h1>
    </nav>

    <div class="max-w-md mx-auto p-4">
        <div id="student-list" class="space-y-4">
            <div class="flex flex-col items-center justify-center py-20">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mb-4"></div>
                <p class="text-gray-500 text-xl">連線雲端資料庫中...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNSfMo7ASbkNOJiQQg6jDwq6dkUYohwDY",
            authDomain: "helpingmymama.firebaseapp.com",
            projectId: "helpingmymama",
            storageBucket: "helpingmymama.firebasestorage.app",
            messagingSenderId: "761189443645",
            appId: "1:761189443645:web:c1061d40916076ba526254",
            measurementId: "G-BLQY5LNWPX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const q = query(collection(db, "students"), orderBy("total_points", "desc"));
        
        onSnapshot(q, (snapshot) => {
            const listDiv = document.getElementById('student-list');
            listDiv.innerHTML = ""; 

            if (snapshot.empty) {
                listDiv.innerHTML = '<p class="text-center text-gray-400 py-10">目前沒有資料，請至 Firebase 新增！</p>';
                return;
            }

            snapshot.forEach((snapshotDoc) => {
                const data = snapshotDoc.data();
                const studentId = snapshotDoc.id;
                
                const card = `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center card-active transition-all cursor-pointer" 
                         onclick="window.handleScoreAction('${studentId}', '${data.name}', ${data.total_points})">
                        <div class="flex items-center gap-5">
                            <span class="text-xl font-bold text-orange-200">#${data.seat_number}</span>
                            <h2 class="text-2xl font-bold text-gray-800">${data.name}</h2>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="text-3xl font-black text-orange-600">${data.total_points || 0}</span>
                            <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Points</span>
                        </div>
                    </div>
                `;
                listDiv.innerHTML += card;
            });
        });

        window.handleScoreAction = async (id, name, currentPoints) => {
            const action = confirm(`【${name}】 目前 ${currentPoints} 分\n\n確定要加 1 分嗎？\n(按「取消」則進入扣分確認)`);
            
            const studentRef = doc(db, "students", id);
            
            if (action) {
                await updateDoc(studentRef, { total_points: currentPoints + 1 });
            } else {
                const confirmMinus = confirm(`確定要扣 【${name}】 1 分嗎？`);
                if (confirmMinus) {
                    await updateDoc(studentRef, { total_points: currentPoints - 1 });
                }
            }
        };
    </script>
</body>
</html>